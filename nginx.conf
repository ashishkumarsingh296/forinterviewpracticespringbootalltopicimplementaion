#!/bin/bash

MAX_REPLICAS=5
MIN_REPLICAS=1

# Get all mynewapp container IDs
CONTAINERS=$(docker ps -q --filter "name=mynewapp")

# Calculate average CPU usage
CPU_AVG=$(docker stats --no-stream --format "{{.CPUPerc}}" $CONTAINERS 2>/dev/null | tr -d '%' | awk '{sum+=$1} END {if(NR>0) print sum/NR; else print 0}')

# Determine desired replicas
CURRENT_REPLICAS=$(echo "$CONTAINERS" | wc -l)
if (( $(echo "$CPU_AVG > 50" | bc -l) )); then
    REPLICAS=$((CURRENT_REPLICAS + 1))
elif (( $(echo "$CPU_AVG < 20" | bc -l) )); then
    REPLICAS=$((CURRENT_REPLICAS - 1))
else
    REPLICAS=$CURRENT_REPLICAS
fi

# Clamp replicas
REPLICAS=$((REPLICAS<MIN_REPLICAS?MIN_REPLICAS:REPLICAS))
REPLICAS=$((REPLICAS>MAX_REPLICAS?MAX_REPLICAS:REPLICAS))

# Scale Docker Compose
docker-compose up -d --scale mynewapp=$REPLICAS

# Reload Nginx inside container
docker-compose exec nginx nginx -s reload
