# version: '3.8'

# services:
#   db:
#     image: mysql:8
#     container_name: mydb
#     restart: always
#     environment:
#       MYSQL_DATABASE: testdb
#       MYSQL_USER: springuser
#       MYSQL_PASSWORD: springpass
#       MYSQL_ROOT_PASSWORD: rootpass
#     ports:
#       - "3306:3306"
#     volumes:
#       - db_data:/var/lib/mysql
#     healthcheck:
#       test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
#       interval: 10s
#       retries: 5

#   app:
#     build: .                  # Dockerfile in current directory
#     image: java-multi-env:latest
#     container_name: myapp
#     restart: on-failure
#     environment:
#       SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/testdb
#       SPRING_DATASOURCE_USERNAME: springuser
#       SPRING_DATASOURCE_PASSWORD: springpass
#     depends_on:
#       db:
#         condition: service_healthy
#     ports:
#       - "8081:8080"

# volumes:
#   db_data:

version: '3.8'

services:
  db-dev:
    image: mysql:8
    container_name: mydb-dev
    environment:
      MYSQL_DATABASE: testdb
      MYSQL_USER: springuser
      MYSQL_PASSWORD: springpass
      MYSQL_ROOT_PASSWORD: rootpass
    ports:
      - "3307:3306"
    networks:
      - myapp-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 5s
      retries: 10

  db-qa:
    image: mysql:8
    container_name: mydb-qa
    environment:
      MYSQL_DATABASE: testdb
      MYSQL_USER: springuser
      MYSQL_PASSWORD: springpass
      MYSQL_ROOT_PASSWORD: rootpass
    ports:
      - "3308:3306"
    networks:
      - myapp-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 5s
      retries: 10

  app-dev:
    image: java-multi-env:${VERSION}
    container_name: myapp-dev
    environment:
      SPRING_PROFILES_ACTIVE: dev
    ports:
      - "8081:8080"
    depends_on:
      db-dev:
        condition: service_healthy
    networks:
      - myapp-network

  app-qa:
    image: java-multi-env:${VERSION}
    container_name: myapp-qa
    environment:
      SPRING_PROFILES_ACTIVE: qa
    ports:
      - "8082:8080"
    depends_on:
      db-qa:
        condition: service_healthy
    networks:
      - myapp-network

networks:
  myapp-network:
    driver: bridge



